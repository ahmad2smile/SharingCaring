<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="background-color: #2c2b2b">
<div>
    <h1>Hello World</h1>
    <button id="start-preview">Start Preview</button>
    <video id="camera-preview"></video>
    <script>
        const video = document.querySelector("#camera-preview");
        const previewBtn = document.querySelector("#start-preview");

        navigator.mediaDevices
            .getUserMedia({video: true, audio: false})
            .then((stream) => {
                const recorder = new MediaRecorder(stream);

                recorder.ondataavailable = (evt) => {
                    fetch("/api/upstream", {method: "POST", body: evt.data}).catch(console.log)
                };

                recorder.start(100);

                // video.srcObject = stream;
                // video.play();
            })
            .catch((err) => {
                console.error(`An error occurred: ${err}`);
            });


        previewBtn.onclick = (e) => {
            // setInterval(() => {
                fetch("http://127.0.0.1:8000/api/downstream").catch(console.log).then(async res => {
                    const reader = res.body.getReader();
                    
                    while (true) {
                        const result = await reader.read();

                        if(result.done){
                            break;
                        }

                        video.src = URL.createObjectURL(new Blob([result.value], {type: "video/webm;codecs=vp8"}));

                        await video.play();
                    }
                });
            // }, 100);
        };
    </script>
</div>
</body>
</html>